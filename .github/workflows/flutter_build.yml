name: Build Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mobile_client

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Create Android Platform Files
        run: flutter create . --org com.vae --platforms android

      - name: Configure Android Project (Python Script)
        run: |
          cat <<EOF > update_config.py
          import os

          # 1. Update AndroidManifest.xml
          manifest_path = 'android/app/src/main/AndroidManifest.xml'
          if os.path.exists(manifest_path):
              with open(manifest_path, 'r', encoding='utf-8') as f:
                  content = f.read()

              permissions = '''
              <uses-permission android:name="android.permission.INTERNET"/>
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>
              <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM"/>
              '''

              if '<application' in content:
                  # Inject permissions
                  content = content.replace('<application', permissions + '\\n    <application')
                  # Add cleartext traffic
                  content = content.replace('<application', '<application android:usesCleartextTraffic="true"')
                  # Update label if it exists directly
                  content = content.replace('android:label="mobile_client"', 'android:label="One-API 助手"')
              
              with open(manifest_path, 'w', encoding='utf-8') as f:
                  f.write(content)
              print("Updated AndroidManifest.xml")

          # 2. Update strings.xml (if label is a reference)
          strings_path = 'android/app/src/main/res/values/strings.xml'
          if os.path.exists(strings_path):
              with open(strings_path, 'r', encoding='utf-8') as f:
                  s_content = f.read()
              s_content = s_content.replace('mobile_client', 'One-API 助手')
              with open(strings_path, 'w', encoding='utf-8') as f:
                  f.write(s_content)
              print("Updated strings.xml")

          # 3. Update build.gradle
          gradle_path = 'android/app/build.gradle'
          if os.path.exists(gradle_path):
              with open(gradle_path, 'r', encoding='utf-8') as f:
                  g_content = f.read()
              # Replace minSdkVersion
              if 'minSdkVersion flutter.minSdkVersion' in g_content:
                  g_content = g_content.replace('minSdkVersion flutter.minSdkVersion', 'minSdkVersion 21')
                  print("Updated minSdkVersion to 21")
              else:
                  print("Warning: Could not find minSdkVersion flutter.minSdkVersion in build.gradle")
              
              with open(gradle_path, 'w', encoding='utf-8') as f:
                  f.write(g_content)
          EOF
          
          python3 update_config.py

      - name: Build APK
        run: flutter build apk --release --no-tree-shake-icons

      - name: List Build Outputs
        run: ls -R build/app/outputs/flutter-apk/

      - name: Rename APK
        run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/OneAPI_Assistant.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: OneAPI_Assistant_APK
          path: mobile_client/build/app/outputs/flutter-apk/OneAPI_Assistant.apk
